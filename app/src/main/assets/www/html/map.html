<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="format-detection" content="telephone=no">
    <meta http-equiv="Access-Control-Allow-Origin" content="*">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,minimum-scale=1, user-scalable=no, width=device-width">
    <title>地图</title>
    <link rel="stylesheet" href="http://cache.amap.com/lbs/static/main1119.css" />
    <link rel="stylesheet" type="text/css" href="../css/map.css" media="screen" title="no title" charset="utf-8">
    <script src="http://cache.amap.com/lbs/static/es5.min.js"></script>
    <script src="http://webapi.amap.com/maps?v=1.3&key=2b85e79b2c837c6461b0dc856f539a70&plugin=AMap.Geocoder"></script>
    <script type="text/javascript" src="http://cache.amap.com/lbs/static/addToolbar.js"></script>
</head>

<body>
    <div id="container"></div>
    <center class="navigate">
        <button id="bt-navigate" type="button" name="button">导航</button>
    </center>
    <script src="../js/base.js" charset="utf-8"></script>
    <script src="../js/jquery.js" charset="utf-8"></script>
    <script>
        var map = new AMap.Map('container', {
            resizeEnable: true,
            zoom: 13
                // center: [jsParams[0].lng, jsParams[0].lat]
        });
        var geocoder = new AMap.Geocoder({
            // city: "010", //城市，默认：“全国”
            // radius: 1000 //范围，默认：500
        });

        function openInfoWindow(addr, lng, lat) {
            //构建信息窗体中显示的内容
            var info = [];
            // info.push("<div onclick=\"window.jsmap.showDialog('" + addr.title + "');\"><div><img style=\"float:left;\" src=\" http://webapi.amap.com/images/autonavi.png \"/></div> ");
            info.push("<div style=\"padding:0px 0px 0px 4px;\"><b>" + addr.title + "</b>");
            // info.push("电话 : 010-84107000   邮编 : 100102");
            info.push("地址 : " + addr.city + addr.district + addr.address + "</div></div>");
            inforWindow = new AMap.InfoWindow({
                content: info.join("<br/>"), //使用默认信息窗体框样式，显示信息内容
                offset: new AMap.Pixel(0, -30)
            });
            inforWindow.open(map, new AMap.LngLat(lng, lat));
        }

        function addMarkers(addr) {
            geocoder.getLocation(addr.city + "市" + addr.district + addr.address, function(status, result) {
                if (status === 'complete' && result.info === 'OK') {
                    console.log("geocoder result " + JSON.stringify(result));
                    var geocode = result.geocodes;
                    var i = 0;
                    // for (var i = 0; i < geocode.length; i++) {
                    var marker = new AMap.Marker({
                        map: map,
                        position: [geocode[i].location.getLng(), geocode[i].location.getLat()],
                        icon: new AMap.Icon({
                            size: new AMap.Size(36, 36), //图标大小
                            imageSize: new AMap.Size(36, 36), //图标大小
                            // image: "http://ico.ooopic.com/iconset01/vista-map-markers-icons/256/158679.png",
                            imageOffset: new AMap.Pixel(0, 0)
                        }),
                        topWhenClick: true
                    });
                    marker.setTitle(addr.title);
                    marker.jo = geocode[i].location;
                    AMap.event.addListener(marker, 'click', function() {
                        // marker.setLabel(null);
                        // alert(this.jo.lng);
                        openInfoWindow(addr, this.jo.getLng(), this.jo.getLat());
                    });
                    map.setZoomAndCenter(13, [geocode[i].location.getLng(), geocode[i].location.getLat()]);
                    document.getElementById('bt-navigate').onclick = function() {
                        window.jscomm.callMap(geocode[i].location.getLat() + "," + geocode[i].location.getLng() + "?q=" + addr.address);
                    };
                    // }
                }
            });
        }
        try {
            var addr = eval("(" + window.jsparams.getJson() + ")");
            addMarkers(addr);
            console.log(window.jsparams.getJson());
        } catch (e) {
            console.log(e);
        } finally {

        }
    </script>
    <!-- <script src="../js/map.js" charset="utf-8"></script> -->
</body>

</html>
